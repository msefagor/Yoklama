<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Otonom Yoklama</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* Tasarım kodların aynen korunmuştur */
        :root { --bg-1: #0f2027; --bg-2: #203a43; --bg-3: #2c5364; --glass-bg: rgba(255, 255, 255, 0.08); --glass-border: 1px solid rgba(255, 255, 255, 0.1); --glass-highlight: rgba(255, 255, 255, 0.2); --accent-grad: linear-gradient(135deg, #00f260 0%, #0575E6 100%); --text: #ffffff; --sidebar-width: 280px; }
        body { margin: 0; padding: 0; background: linear-gradient(135deg, var(--bg-1), var(--bg-2), var(--bg-3)); color: var(--text); font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif; min-height: 100vh; overflow: hidden; }
        .blob { position: absolute; filter: blur(80px); z-index: -1; opacity: 0.5; animation: move 15s infinite alternate; }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #0575E6; border-radius: 50%; }
        .blob-2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: #00f260; border-radius: 50%; }
        @keyframes move { from { transform: translate(0,0); } to { transform: translate(30px, -30px); } }
        .hidden { display: none !important; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(15px); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .loader-content { text-align: center; }
        .spinner { width: 50px; height: 50px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.1); border-top-color: #00f260; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 2000; display: flex; flex-direction: column; gap:10px; pointer-events: none; }
        .toast { background: rgba(30,30,30,0.9); color: white; padding: 15px 25px; border-radius: 12px; border-left: 4px solid #00f260; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); pointer-events: auto; animation: slideInRight 0.3s; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity:0; } to { transform: translateX(0); opacity:1; } }
        .main-btn, .action-btn { background: var(--accent-grad); border: none; color: white; padding: 15px 30px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 16px; display: inline-flex; align-items: center; gap: 10px; justify-content: center; }
        .main-btn:hover, .action-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .secondary { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); }
        input, select { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: white; width: 100%; box-sizing: border-box; outline: none; margin-bottom: 10px; }
        .dashboard-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; }
        .sidebar { width: var(--sidebar-width); flex-shrink: 0; background: rgba(255,255,255,0.03); border-right: var(--glass-border); backdrop-filter: blur(20px); display: flex; flex-direction: column; padding: 20px; transition: 0.3s; overflow: hidden; }
        .sidebar.collapsed { width: 0; padding: 20px 0; border: none; }
        .nav-item { padding: 15px; border-radius: 12px; color: rgba(255,255,255,0.7); cursor: pointer; display: flex; align-items: center; gap: 12px; margin-bottom: 5px; }
        .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .course-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .course-card { background: var(--glass-bg); border: var(--glass-border); border-radius: 20px; padding: 25px; cursor: pointer; transition: 0.3s; position: relative; height: 150px; display: flex; flex-direction: column; justify-content: space-between; }
        .course-card:hover { transform: translateY(-5px); background: var(--glass-highlight); }
        .detail-layout { display: flex; gap: 20px; height: 100%; }
        .detail-sidebar { width: 250px; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; }
        .detail-main { flex: 1; background: var(--glass-bg); border: var(--glass-border); border-radius: 20px; padding: 30px; overflow-y: auto; }
        .detail-tab-btn { padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 600; }
        .detail-tab-btn.active { background: var(--accent-grad); }
        .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); }
        .qr-content { background: rgba(255,255,255,0.1); padding: 30px; border-radius: 30px; text-align: center; }
        .mobile-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; }
        .mobile-card { background: var(--glass-bg); backdrop-filter: blur(20px); border: var(--glass-border); padding: 30px; border-radius: 30px; width: 90%; max-width: 400px; }
        .upload-area { border: 2px dashed rgba(255,255,255,0.2); border-radius: 20px; padding: 40px; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { border-color: #00f260; background: rgba(255,255,255,0.05); }
        .week-item-desktop { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .week-item-desktop.locked { opacity: 0.5; filter: grayscale(1); }
    </style>
</head>
<body>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div id="toast-container"></div>
    <div id="loader" class="hidden">
        <div class="loader-content"><div class="spinner"></div><h3>İşleniyor...</h3></div>
    </div>

    <div id="screen-home" class="mobile-screen">
        <div style="margin-bottom: 40px;"><i class="fas fa-university" style="font-size: 60px; color: #00f260;"></i><h1>Otonom Yoklama</h1></div>
        <div class="mobile-card">
            <button class="main-btn" style="width:100%; background: #667eea;" onclick="nav('screen-student-login')"><i class="fas fa-user-graduate"></i> Öğrenci Girişi</button>
            <button class="main-btn" style="width:100%; margin-top:15px; background: #FF416C;" onclick="nav('screen-admin-login')"><i class="fas fa-chalkboard-teacher"></i> Akademisyen Girişi</button>
        </div>
    </div>

    <div id="screen-admin-login" class="mobile-screen hidden">
        <div class="mobile-card">
            <h2>Akademisyen Paneli</h2>
            <input type="password" id="adminPass" placeholder="Yönetici Şifresi">
            <button class="action-btn" style="width:100%;" onclick="adminLogin()">Giriş Yap</button>
            <button class="secondary action-btn" style="width:100%; margin-top:10px;" onclick="nav('screen-home')">Geri</button>
        </div>
    </div>

    <div id="screen-admin-dash" class="dashboard-container hidden">
        <aside class="sidebar collapsed" id="sidebar">
            <div class="nav-item active" onclick="showPanel('courses')"><i class="fas fa-th-large"></i> Dersler</div>
            <div class="nav-item" onclick="showPanel('upload')"><i class="fas fa-file-upload"></i> Veri Yükle</div>
            <div class="nav-item" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i> Çıkış</div>
        </aside>

        <main class="main-content">
            <div style="display:flex; align-items:center; margin-bottom:20px;">
                <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;"><i class="fas fa-bars"></i></button>
                <h2 id="dash-title" style="margin-left:20px;">Dersler</h2>
            </div>
            <div id="courseListPanel" class="course-grid"></div>
            <div id="uploadPanel" class="hidden" style="max-width:600px; margin:0 auto;">
                <div class="mobile-card" style="width:100%;">
                    <input type="text" id="manualCourseCode" placeholder="Ders Kodu">
                    <input type="text" id="manualCourseName" placeholder="Ders Adı">
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-file-pdf" style="font-size:40px; color:#FF416C;"></i>
                        <p>PDF Seçin</p>
                        <input type="file" id="fileInput" accept=".pdf" style="display:none" onchange="handleFileSelect(this)">
                    </div>
                    <button id="btnUpload" class="action-btn" style="width:100%; margin-top:20px; display:none;" onclick="uploadData()">İşle ve Kaydet</button>
                </div>
            </div>
            
            <div id="courseDetailPanel" class="detail-layout hidden">
                <div class="detail-sidebar">
                    <button class="secondary action-btn" onclick="showPanel('courses')"><i class="fas fa-arrow-left"></i> Geri</button>
                    <div class="detail-tab-btn active" onclick="setTab('scan')">Yoklama & Oturum</div>
                    <div class="detail-tab-btn" onclick="setTab('list')">Öğrenci Listesi</div>
                    <div class="detail-tab-btn" onclick="setTab('settings')">Ayarlar</div>
                </div>
                <div class="detail-main">
                    <div id="tab-scan" class="tab-content active">
                        <div id="week-list-view"><div id="weeks-list-container"></div></div>
                        <div id="week-focus-view" class="hidden">
                            <button onclick="backToWeeks()" class="secondary action-btn">Geri Dön</button>
                            <h2 id="focus-week-title"></h2>
                            <div id="session-controls" class="hidden">
                                <select id="sessHours"></select>
                                <button class="action-btn" onclick="startSession()">Oturumu Başlat</button>
                            </div>
                            <div id="week-attendees-list" style="margin-top:20px;"></div>
                        </div>
                    </div>
                    <div id="tab-list" class="tab-content hidden"><div id="studentList"></div></div>
                    <div id="tab-settings" class="tab-content hidden">
                         <input type="number" id="setLimitPct" placeholder="Devamsızlık Sınırı %">
                         <input type="number" id="setWeeklyHours" placeholder="Haftalık Saat">
                         <button class="action-btn" onclick="saveSettings()">Kaydet</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="screen-student-login" class="mobile-screen hidden">
        <div class="mobile-card">
            <h2>Öğrenci Girişi</h2>
            <div id="stu-step-1">
                <input type="tel" id="stuId" placeholder="Öğrenci Numarası">
                <button class="action-btn" style="width:100%;" onclick="checkStudentName()">Devam Et</button>
            </div>
            <div id="stu-step-2" class="hidden">
                <h3 id="studentNameDisplay"></h3>
                <button class="action-btn" style="width:100%;" onclick="startQRScanner()">Kamerayı Aç</button>
            </div>
            <button class="secondary action-btn" style="width:100%; margin-top:10px;" onclick="nav('screen-home')">Geri</button>
        </div>
    </div>

    <div id="screen-student-scan" class="mobile-screen hidden">
        <div class="mobile-card">
            <div id="reader" style="width:100%;"></div>
            <button class="secondary action-btn" onclick="stopScan()">İptal</button>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyi4Wg-P0Ji_Wc_eYKSLpQluQ465gFnayERIAUe6bMafjVFeX54Ts3d0z2S9XjarBef/exec"; 
        let currentAdminPass = ""; 
        let currCourse = null; let cData = null; let qrScanner = null; let unlockedWeeks = []; let uploadFileContent = null; let selectedWeekNo = null;

        function nav(id) {
            document.querySelectorAll('.mobile-screen, .dashboard-container').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        async function api(payload) {
            showLoader();
            try {
                const req = await fetch(API_URL, {method:'POST', body:JSON.stringify(payload)});
                const res = await req.json(); hideLoader(); return res;
            } catch(e) { hideLoader(); showToast("Bağlantı Hatası"); return null; }
        }

        async function adminLogin() {
            const pass = document.getElementById('adminPass').value;
            const res = await api({action:'admin_login', password:pass});
            if(res && res.success) {
                currentAdminPass = pass; // GÜVENLİK: Şifre oturum boyunca burada saklanır
                nav('screen-admin-dash');
                renderCourseGrid(res.courses);
            } else showToast("Hatalı Şifre");
        }

        function renderCourseGrid(courses) {
            const p = document.getElementById('courseListPanel'); p.innerHTML = "";
            courses.forEach(c => {
                const el = document.createElement('div'); el.className = "course-card";
                el.innerHTML = `<div><b>${c.id}</b><br>${c.name}</div><i class="fas fa-chevron-right"></i>`;
                el.onclick = () => loadCourse(c.id); p.appendChild(el);
            });
        }

        async function loadCourse(id) {
            currCourse = id; const res = await api({action:'get_course_details', courseId:id});
            if(res && res.success) {
                cData = res;
                document.getElementById('courseListPanel').classList.add('hidden');
                document.getElementById('courseDetailPanel').classList.remove('hidden');
                document.getElementById('setLimitPct').value = res.settings.limitPct;
                document.getElementById('setWeeklyHours').value = res.settings.weeklyHours;
                renderWeeksList(res.weeks); renderStudentList(res.students);
            }
        }

        async function uploadData() {
            const code = document.getElementById('manualCourseCode').value;
            const name = document.getElementById('manualCourseName').value;
            if(!code || !name || !uploadFileContent) return alert("Eksik bilgi!");
            const res = await api({ 
                action: 'upload_pdf_data', 
                adminPass: currentAdminPass, // GÜVENLİK: Her istekte şifre gönderilir
                fileData: uploadFileContent, courseCode: code, courseName: name
            });
            if(res && res.success) { alert(res.msg); location.reload(); } else alert(res.error);
        }

        function renderWeeksList(weeks) {
            const container = document.getElementById('weeks-list-container'); container.innerHTML = "";
            weeks.forEach(w => {
                if(w.type !== 'Normal') return;
                const el = document.createElement('div'); el.className = "week-item-desktop";
                el.innerHTML = `<span>${w.weekNo}. Hafta (${w.date})</span><i class="fas fa-chevron-right"></i>`;
                el.onclick = () => openWeekFocus(w);
                container.appendChild(el);
            });
        }

        async function openWeekFocus(week) {
            selectedWeekNo = week.weekNo;
            document.getElementById('week-list-view').classList.add('hidden');
            document.getElementById('week-focus-view').classList.remove('hidden');
            document.getElementById('focus-week-title').innerText = week.weekNo + ". Hafta";
            const hSel = document.getElementById('sessHours'); hSel.innerHTML = "";
            for(let i=1; i<=3; i++) { hSel.add(new Option(i + " Saat", i)); }
            document.getElementById('session-controls').classList.remove('hidden');
            loadWeekAttendees(currCourse, week.weekNo);
        }

        async function startSession() {
            const hrs = document.getElementById('sessHours').value;
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const res = await api({
                    action: 'start_session', adminPass: currentAdminPass,
                    courseId: currCourse, weekNo: selectedWeekNo, hoursVal: hrs,
                    lat: pos.coords.latitude, lng: pos.coords.longitude
                });
                if(res.success) alert("Oturum Başladı!");
            });
        }

        async function checkStudentName() {
            const id = document.getElementById('stuId').value;
            const res = await api({ action: 'get_student_name', studentId: id });
            if(res.success) {
                document.getElementById('stu-step-1').classList.add('hidden');
                document.getElementById('stu-step-2').classList.remove('hidden');
                document.getElementById('studentNameDisplay').innerText = res.name;
            } else showToast("Bulunamadı");
        }

        function startQRScanner() {
            nav('screen-student-scan');
            qrScanner = new Html5Qrcode("reader");
            qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (txt) => {
                qrScanner.stop();
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const res = await api({
                        action: 'student_scan', studentId: document.getElementById('stuId').value,
                        qrCourseId: txt, lat: pos.coords.latitude, lng: pos.coords.longitude
                    });
                    alert(res.success ? "Yoklama Alındı" : res.error);
                    nav('screen-home');
                });
            });
        }

        // Yardımcı Fonksiyonlar
        function showPanel(p) {
            document.getElementById('courseListPanel').classList.toggle('hidden', p !== 'courses');
            document.getElementById('uploadPanel').classList.toggle('hidden', p !== 'upload');
            document.getElementById('courseDetailPanel').classList.add('hidden');
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        function showLoader() { document.getElementById('loader').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('loader').classList.add('hidden'); }
        function showToast(m) { const t=document.createElement('div'); t.className='toast'; t.innerText=m; document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(),3000); }
        function handleFileSelect(i) { const f=i.files[0]; const r=new FileReader(); r.onload=(e)=>uploadFileContent=e.target.result.split(',')[1]; r.readAsDataURL(f); document.getElementById('btnUpload').style.display='block'; }
        function backToWeeks() { document.getElementById('week-focus-view').classList.add('hidden'); document.getElementById('week-list-view').classList.remove('hidden'); }
        function setTab(t) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); }
    </script>
</body>
</html>
